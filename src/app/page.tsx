'use client';

import React, { useRef, useEffect, useState, useCallback } from 'react';

const GlobePrototype = () => {
  const globeEl = useRef<HTMLDivElement>(null);
  const globeRef = useRef<any>(null);
  const zoomTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const [selectedCountry, setSelectedCountry] = useState<string | null>(null);
  const [currentGlobeIndex, setCurrentGlobeIndex] = useState(0);
  const [zoomLevel, setZoomLevel] = useState(2.5);
  const [clusteredData, setClusteredData] = useState<any[]>([]);
  const [globeLoading, setGlobeLoading] = useState(false);
  const [globeError, setGlobeError] = useState<string | null>(null);

  // Ïó¨Ìñâ Ìå®ÌÑ¥Îì§
  const travelPatterns = [
    {
      title: 'ÏïÑÏãúÏïÑ Î¨∏Ìôî Ïó¨Ìñâ',
      subtitle: 'Ï†ÑÌÜµÍ≥º ÌòÑÎåÄÍ∞Ä Í≥µÏ°¥ÌïòÎäî ÏïÑÏãúÏïÑÏùò Îß§Î†•',
      countries: [
        {
          id: 'JPN',
          name: 'ÎèÑÏøÑ, ÏùºÎ≥∏',
          flag: 'üáØüáµ',
          lat: 35.6762,
          lng: 139.6503,
          color: '#e91e63',
        },
        {
          id: 'JPN2',
          name: 'Ïò§ÏÇ¨Ïπ¥, ÏùºÎ≥∏',
          flag: 'üáØüáµ',
          lat: 34.6937,
          lng: 135.5023,
          color: '#e91e63',
        },
        {
          id: 'JPN3',
          name: 'ÍµêÌÜ†, ÏùºÎ≥∏',
          flag: 'üáØüáµ',
          lat: 35.0116,
          lng: 135.7681,
          color: '#e91e63',
        },
        {
          id: 'KOR',
          name: 'ÏÑúÏö∏, ÌïúÍµ≠',
          flag: 'üá∞üá∑',
          lat: 37.5665,
          lng: 126.978,
          color: '#9c27b0',
        },
        {
          id: 'TWN',
          name: 'ÌÉÄÏù¥Î≤†Ïù¥, ÎåÄÎßå',
          flag: 'üáπüáº',
          lat: 25.033,
          lng: 121.5654,
          color: '#673ab7',
        },
        {
          id: 'THA',
          name: 'Î∞©ÏΩï, ÌÉúÍµ≠',
          flag: 'üáπüá≠',
          lat: 13.7563,
          lng: 100.5018,
          color: '#3f51b5',
        },
        {
          id: 'SGP',
          name: 'Ïã±Í∞ÄÌè¨Î•¥',
          flag: 'üá∏üá¨',
          lat: 1.3521,
          lng: 103.8198,
          color: '#2196f3',
        },
      ],
    },
    {
      title: 'ÏÑ∏Í≥Ñ Î™ÖÏÜå ÏàúÎ°Ä',
      subtitle: 'ÍøàÏóê Í∑∏Î¶¨Îçò ÏÑ∏Í≥Ñ Í∞ÅÍµ≠Ïùò ÎûúÎìúÎßàÌÅ¨Îì§',
      countries: [
        {
          id: 'USA',
          name: 'Îâ¥Ïöï, ÎØ∏Íµ≠',
          flag: 'üá∫üá∏',
          lat: 40.7128,
          lng: -74.006,
          color: '#f44336',
        },
        {
          id: 'FRA',
          name: 'ÌååÎ¶¨, ÌîÑÎûëÏä§',
          flag: 'üá´üá∑',
          lat: 48.8566,
          lng: 2.3522,
          color: '#e91e63',
        },
        {
          id: 'EGY',
          name: 'Ïπ¥Ïù¥Î°ú, Ïù¥ÏßëÌä∏',
          flag: 'üá™üá¨',
          lat: 30.0444,
          lng: 31.2357,
          color: '#9c27b0',
        },
        {
          id: 'BRA',
          name: 'Î¶¨Ïö∞Îç∞ÏûêÎÑ§Ïù¥Î£®, Î∏åÎùºÏßà',
          flag: 'üáßüá∑',
          lat: -22.9068,
          lng: -43.1729,
          color: '#4caf50',
        },
        {
          id: 'AUS',
          name: 'ÏãúÎìúÎãà, Ìò∏Ï£º',
          flag: 'üá¶üá∫',
          lat: -33.8688,
          lng: 151.2093,
          color: '#00bcd4',
        },
      ],
    },
    {
      title: 'Ïú†ÎüΩ Î°úÎß®Ìã± Ïó¨Ìñâ',
      subtitle: 'ÎÇ≠ÎßåÏ†ÅÏù∏ Ïú†ÎüΩÏùò Í≥†ÏÑ±Í≥º Í±∞Î¶¨Îì§',
      countries: [
        {
          id: 'ITA',
          name: 'Î°úÎßà, Ïù¥ÌÉàÎ¶¨ÏïÑ',
          flag: 'üáÆüáπ',
          lat: 41.9028,
          lng: 12.4964,
          color: '#ff9800',
        },
        {
          id: 'ESP',
          name: 'Î∞îÎ•¥ÏÖÄÎ°úÎÇò, Ïä§ÌéòÏù∏',
          flag: 'üá™üá∏',
          lat: 41.3851,
          lng: 2.1734,
          color: '#4caf50',
        },
        {
          id: 'GBR',
          name: 'Îü∞Îçò, ÏòÅÍµ≠',
          flag: 'üá¨üáß',
          lat: 51.5074,
          lng: -0.1278,
          color: '#2196f3',
        },
        {
          id: 'DEU',
          name: 'Î≤†Î•ºÎ¶∞, ÎèÖÏùº',
          flag: 'üá©üá™',
          lat: 52.52,
          lng: 13.405,
          color: '#ff5722',
        },
        {
          id: 'CHE',
          name: 'Ï∑®Î¶¨Ìûà, Ïä§ÏúÑÏä§',
          flag: 'üá®üá≠',
          lat: 47.3769,
          lng: 8.5417,
          color: '#795548',
        },
      ],
    },
  ];

  const currentPattern = travelPatterns[currentGlobeIndex];

  // ISO ÏΩîÎìú Îß§Ìïë Ìï®Ïàò
  const getISOCode = (countryId: string): string => {
    const isoMap: { [key: string]: string } = {
      JPN: 'JPN',
      JPN2: 'JPN',
      JPN3: 'JPN',
      KOR: 'KOR',
      TWN: 'TWN',
      THA: 'THA',
      SGP: 'SGP',
      USA: 'USA',
      FRA: 'FRA',
      EGY: 'EGY',
      BRA: 'BRA',
      AUS: 'AUS',
      ITA: 'ITA',
      ESP: 'ESP',
      GBR: 'GBR',
      DEU: 'DEU',
      CHE: 'CHE',
    };
    return isoMap[countryId] || countryId;
  };

  // Í±∞Î¶¨ Í∏∞Î∞ò ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Ìï®Ïàò
  const clusterLocations = (locations: any[], distance: number) => {
    const clusters: any[] = [];
    const processed = new Set();

    locations.forEach((location, index) => {
      if (processed.has(index)) return;

      const cluster = {
        id: location.id,
        name: location.name,
        flag: location.flag,
        lat: location.lat,
        lng: location.lng,
        color: location.color,
        items: [location],
        count: 1,
      };

      // Ï£ºÎ≥ÄÏùò Í∞ÄÍπåÏö¥ ÏúÑÏπòÎì§ÏùÑ ÌÅ¥Îü¨Ïä§ÌÑ∞Ïóê Ï∂îÍ∞Ä
      locations.forEach((otherLocation, otherIndex) => {
        if (otherIndex === index || processed.has(otherIndex)) return;

        const dist = Math.sqrt(
          Math.pow(location.lat - otherLocation.lat, 2) +
            Math.pow(location.lng - otherLocation.lng, 2)
        );

        if (dist < distance) {
          cluster.items.push(otherLocation);
          cluster.count++;
          processed.add(otherIndex);

          // ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï§ëÏã¨Ï†ê Ïû¨Í≥ÑÏÇ∞
          const totalLat = cluster.items.reduce(
            (sum, item) => sum + item.lat,
            0
          );
          const totalLng = cluster.items.reduce(
            (sum, item) => sum + item.lng,
            0
          );
          cluster.lat = totalLat / cluster.items.length;
          cluster.lng = totalLng / cluster.items.length;
        }
      });

      processed.add(index);
      clusters.push(cluster);
    });

    return clusters;
  };

  // Ï§å Î†àÎ≤®Ïóê Îî∞Î•∏ ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Í±∞Î¶¨ Í≥ÑÏÇ∞
  const getClusterDistance = (zoom: number) => {
    // zoomÏù¥ ÌÅ¥ÏàòÎ°ù Î©ÄÎ¶¨ÏÑú Î≥¥Îäî Í≤É (altitudeÍ∞Ä ÎÜíÏùå)
    // zoomÏù¥ ÏûëÏùÑÏàòÎ°ù Í∞ÄÍπåÏù¥ÏÑú Î≥¥Îäî Í≤É (altitudeÍ∞Ä ÎÇÆÏùå)

    if (zoom > 4) return 15; // Îß§Ïö∞ Î©ÄÎ¶¨ÏÑú Î≥º Îïå - Í∞ïÌïú ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ
    if (zoom > 3) return 10; // Î©ÄÎ¶¨ÏÑú Î≥º Îïå - Ï§ëÍ∞Ñ ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ
    if (zoom > 2) return 5; // Ï§ëÍ∞Ñ Í±∞Î¶¨ - ÏïΩÌïú ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ
    if (zoom > 1.5) return 2; // Í∞ÄÍπåÏù¥ÏÑú Î≥º Îïå - Îß§Ïö∞ ÏïΩÌïú ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ
    return 0; // Îß§Ïö∞ Í∞ÄÍπåÏù¥ÏÑú Î≥º Îïå - ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Ìï¥Ï†ú
  };

  // Î∏åÎùºÏö∞Ï†Ä Í∏∞Î≥∏ ÌôïÎåÄ/Ï∂ïÏÜå Î∞©ÏßÄ
  useEffect(() => {
    const preventZoom = (e: WheelEvent) => {
      if (e.ctrlKey) {
        e.preventDefault();
      }
    };

    const preventKeyboardZoom = (e: KeyboardEvent) => {
      if (
        e.ctrlKey &&
        (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')
      ) {
        e.preventDefault();
      }
    };

    const preventTouchZoom = (e: TouchEvent) => {
      if (e.touches.length > 1) {
        e.preventDefault();
      }
    };

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    document.addEventListener('wheel', preventZoom, { passive: false });
    document.addEventListener('keydown', preventKeyboardZoom);
    document.addEventListener('touchstart', preventTouchZoom, {
      passive: false,
    });

    return () => {
      // ÌÅ¥Î¶∞ÏóÖ
      document.removeEventListener('wheel', preventZoom);
      document.removeEventListener('keydown', preventKeyboardZoom);
      document.removeEventListener('touchstart', preventTouchZoom);
    };
  }, []);

  // Ïπ¥Î©îÎùº Ï§å Î†àÎ≤®ÏùÑ Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Ï≤¥ÌÅ¨ (onZoom Ïù¥Î≤§Ìä∏ ÎåÄÏã† ÏÇ¨Ïö©)
  useEffect(() => {
    if (!globeRef.current) return;

    const checkZoomLevel = () => {
      if (globeRef.current) {
        const camera = globeRef.current.camera();
        if (camera && camera.position) {
          const currentAltitude = camera.position.length() / globeRef.current.getGlobeRadius() - 1;
          
          // ÌòÑÏû¨ Ï§å Î†àÎ≤®Í≥º Ï∞®Ïù¥Í∞Ä ÌÅ¥ ÎïåÎßå ÏóÖÎç∞Ïù¥Ìä∏
          if (Math.abs(currentAltitude - zoomLevel) > 0.2) {
            setZoomLevel(currentAltitude);
          }
        }
      }
    };

    // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Ï§å Î†àÎ≤® Ï≤¥ÌÅ¨ (onZoom Ïù¥Î≤§Ìä∏ ÎåÄÏã†)
    const interval = setInterval(checkZoomLevel, 200);

    return () => clearInterval(interval);
  }, [zoomLevel]); // zoomLevelÏùÑ ÏùòÏ°¥ÏÑ±Ïóê Ìè¨Ìï®ÌïòÎêò, ÌÅ∞ Î≥ÄÌôîÍ∞Ä ÏûàÏùÑ ÎïåÎßå ÏóÖÎç∞Ïù¥Ìä∏

  useEffect(() => {
    // Globe.gl ÎèôÏ†Å Î°úÎî©
    const loadGlobe = async () => {
      try {
        setGlobeLoading(true);
        setGlobeError(null);

        if (!globeEl.current) {
          setGlobeError('Globe container not found');
          return;
        }

        const Globe = (await import('globe.gl')).default;

        if (!Globe) {
          setGlobeError('Failed to load Globe.gl library');
          return;
        }

        // Í∏∞Ï°¥ ÎÇ¥Ïö© Ï†úÍ±∞
        globeEl.current.innerHTML = '';

        const globe = new Globe(globeEl.current)
          // Blue Marble Í≥†Ìï¥ÏÉÅÎèÑ ÏßÄÍµ¨Î≥∏ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©
          .globeImageUrl(
            '//unpkg.com/three-globe/example/img/earth-blue-marble.jpg'
          )
          .bumpImageUrl(
            '//unpkg.com/three-globe/example/img/earth-topology.png'
          )
          .backgroundImageUrl(
            '//unpkg.com/three-globe/example/img/night-sky.png'
          )
          .width(500)
          .height(500)
          .showGlobe(true)
          .showAtmosphere(true)
          .atmosphereColor('#4a90e2')
          .atmosphereAltitude(0.15);

        // globe Ï∞∏Ï°∞ Ï†ÄÏû•
        globeRef.current = globe;
        console.log('Globe initialized successfully');

        // Ïπ¥Î©îÎùº Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï£ºÍ∏∞Ï†Å Ï≤¥ÌÅ¨Î°ú ÎåÄÏ≤¥)

        // Íµ≠Í∞Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        fetch('//unpkg.com/world-atlas/countries-110m.json')
          .then((res) => res.json())
          .then((countriesData) => {
            // ÌòÑÏû¨ Ìå®ÌÑ¥Ïùò Î∞©Î¨∏Ìïú Íµ≠Í∞ÄÎì§Ïùò ISO ÏΩîÎìú Í≥ÑÏÇ∞
            const currentVisitedISOCodes = [
              ...new Set(currentPattern.countries.map((c) => getISOCode(c.id))),
            ];

            // countriesDataÍ∞Ä undefinedÏù¥Í±∞ÎÇò featuresÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ Îπà Î∞∞Ïó¥ ÏÇ¨Ïö©
            const features = countriesData?.features || [];

            globe
              .polygonsData(
                features.filter((d: any) =>
                  currentVisitedISOCodes.includes(d.properties.ISO_A3)
                )
              )
              .polygonCapColor((feat: any) => {
                const isoCode = feat.properties.ISO_A3;
                const countryData = currentPattern.countries.find(
                  (c: any) => getISOCode(c.id) === isoCode
                );

                // ÏÑ†ÌÉùÎêú Íµ≠Í∞ÄÏù∏ÏßÄ ÌôïÏù∏ (selectedCountryÎäî country.id ÌòïÌÉú)
                const isSelected =
                  selectedCountry &&
                  currentPattern.countries.find(
                    (c) =>
                      c.id === selectedCountry && getISOCode(c.id) === isoCode
                  );

                if (isSelected) {
                  return countryData?.color || '#ff6b6b'; // Î∞ùÏùÄ ÏÉâÏÉÅ
                } else if (countryData) {
                  return `${countryData.color}88`; // Î∞òÌà¨Î™Ö ÏÉâÏÉÅ
                } else {
                  return 'rgba(100, 100, 100, 0.2)'; // Í∏∞Î≥∏ ÌöåÏÉâ
                }
              })
              .polygonSideColor((feat: any) => {
                const isoCode = feat.properties.ISO_A3;
                const isSelected =
                  selectedCountry &&
                  currentPattern.countries.find(
                    (c) =>
                      c.id === selectedCountry && getISOCode(c.id) === isoCode
                  );
                return isSelected ? '#555555' : '#333333';
              })
              .polygonStrokeColor((feat: any) => {
                const isoCode = feat.properties.ISO_A3;
                const isSelected =
                  selectedCountry &&
                  currentPattern.countries.find(
                    (c) =>
                      c.id === selectedCountry && getISOCode(c.id) === isoCode
                  );
                return isSelected ? '#ffffff' : '#111111';
              })
              .polygonAltitude((feat: any) => {
                const isoCode = feat.properties.ISO_A3;
                const isSelected =
                  selectedCountry &&
                  currentPattern.countries.find(
                    (c) =>
                      c.id === selectedCountry && getISOCode(c.id) === isoCode
                  );
                return isSelected ? 0.03 : 0.005;
              })
              .polygonLabel('')
              .onPolygonClick((polygon: any) => {
                const countryISOCode = polygon.properties.ISO_A3;

                // ÌÅ¥Î¶≠Îêú ISO ÏΩîÎìúÏóê Ìï¥ÎãπÌïòÎäî Ï≤´ Î≤àÏß∏ ÎèÑÏãú Ï∞æÍ∏∞
                const clickedCountry = currentPattern.countries.find(
                  (c: any) => getISOCode(c.id) === countryISOCode
                );

                if (clickedCountry) {
                  setSelectedCountry(clickedCountry.id);
                  globe.pointOfView(
                    {
                      lat: clickedCountry.lat,
                      lng: clickedCountry.lng,
                      altitude: 1.5,
                    },
                    1000
                  );
                }
              });
          });

        // ÏûêÎèô ÌöåÏ†Ñ
        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.5;
        globe.controls().enableZoom = true;
        globe.controls().minDistance = 101; // ÏµúÏÜå Í±∞Î¶¨ ÏÑ§Ï†ï
        globe.controls().maxDistance = 1000; // ÏµúÎåÄ Í±∞Î¶¨ ÏÑ§Ï†ï

        // Î†åÎçîÎü¨ ÌíàÏßà Í∞úÏÑ†
        const renderer = globe.renderer();
        if (renderer) {
          renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          renderer.shadowMap.enabled = true;
          renderer.shadowMap.type = 2; // PCFSoftShadowMap
        }

        // ÏßÄÍµ¨Î≥∏ Í∞ùÏ≤¥Ïóê Ï†ëÍ∑ºÌïòÏó¨ ÌÖçÏä§Ï≤ò ÌïÑÌÑ∞ÎßÅ Í∞úÏÑ†
        setTimeout(() => {
          const scene = globe.scene();
          if (scene) {
            scene.traverse((child: any) => {
              if (child.material && child.material.map) {
                child.material.map.generateMipmaps = true;
                child.material.map.minFilter = 1008; // LinearMipmapLinearFilter
                child.material.map.magFilter = 1006; // LinearFilter
                child.material.map.anisotropy =
                  renderer?.capabilities?.getMaxAnisotropy() || 4;
              }
            });
          }
        }, 1000);

        // Ï¥àÍ∏∞ Ïπ¥Î©îÎùº ÏúÑÏπò
        globe.pointOfView({ altitude: 2.5 });

        setGlobeLoading(false);
        console.log('Globe setup completed successfully');
      } catch (error) {
        console.error('Globe.gl Î°úÎî© Ïã§Ìå®:', error);
        const errorMessage =
          error instanceof Error ? error.message : String(error);
        setGlobeError(`Globe.gl Î°úÎî© Ïã§Ìå®: ${errorMessage}`);
        setGlobeLoading(false);
        // Ìè¥Î∞± UI ÌëúÏãú
        if (globeEl.current) {
          globeEl.current.innerHTML = `
            <div style="
              width: 500px; 
              height: 500px; 
              background: radial-gradient(circle at 30% 30%, #2c3e50 0%, #1a252f 100%);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 14px;
              text-align: center;
              flex-direction: column;
              gap: 10px;
            ">
              <div>‚ö†Ô∏è Globe.gl Î°úÎî© Ïã§Ìå®</div>
              <div style="font-size: 12px; opacity: 0.8;">Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî</div>
            </div>
          `;
        }
      }
    };

    loadGlobe();
  }, [selectedCountry, currentGlobeIndex]);

  // Ï§å Î†àÎ≤® Î≥ÄÍ≤ΩÏóê Îî∞Î•∏ ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ ÏóÖÎç∞Ïù¥Ìä∏ (Î≥ÑÎèÑ useEffectÎ°ú Î∂ÑÎ¶¨)
  useEffect(() => {
    if (!globeRef.current) return;

    // Ï§å Î†àÎ≤®Ïù¥ ÎÑàÎ¨¥ ÎÜíÏúºÎ©¥ (ÎÑàÎ¨¥ Î©ÄÎ¶¨ÏÑú Î≥¥Î©¥) ÎùºÎ≤® Ïà®Í∏∞Í∏∞
    if (zoomLevel > 6) {
      globeRef.current.htmlElementsData([]);
      setClusteredData([]);
      return;
    }

    const clusterDistance = getClusterDistance(zoomLevel);
    const clusters = clusterLocations(
      currentPattern.countries,
      clusterDistance
    );

    // ÌÅ¥Îü¨Ïä§ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
    setClusteredData(clusters);
  }, [zoomLevel, currentGlobeIndex]); // currentPattern.countries ÎåÄÏã† currentGlobeIndex ÏÇ¨Ïö©

  // ÌÅ¥Îü¨Ïä§ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä Î≥ÄÍ≤ΩÎê† Îïå HTML ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    if (!globeRef.current || clusteredData.length === 0) return;
    
    // HTML ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
    globeRef.current
      .htmlElementsData(clusteredData)
      .htmlLat((d: any) => d.lat)
      .htmlLng((d: any) => d.lng)
      .htmlAltitude(0.01)
      .htmlElement((d: any) => {
        const el = document.createElement('div');

        // ÌÅ¥Îü¨Ïä§ÌÑ∞Ïù∏ Í≤ΩÏö∞ÏôÄ Îã®Ïùº ÏïÑÏù¥ÌÖúÏù∏ Í≤ΩÏö∞ Îã§Î•¥Í≤å ÌëúÏãú
        const isCluster = d.count > 1;
        const displayText = isCluster ? `${d.count}Í∞ú ÎèÑÏãú` : d.name;

        // Ï§å Î†àÎ≤®Ïóê Îî∞Î•∏ ÎùºÎ≤® ÌÅ¨Í∏∞ Ï°∞Ï†à
        const scaleFactor = Math.max(0.8, Math.min(1.5, 3 / zoomLevel));
        const fontSize = Math.round(13 * scaleFactor);
        const flagSize = Math.round(16 * scaleFactor);
        const padding = Math.round(8 * scaleFactor);

        el.innerHTML = `
          <div style="
            background: ${
              isCluster
                ? 'rgba(74, 144, 226, 0.95)'
                : 'rgba(255, 255, 255, 0.95)'
            };
            color: ${isCluster ? 'white' : '#333'};
            padding: ${padding}px ${padding * 1.5}px;
            border-radius: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: ${fontSize}px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            min-width: ${isCluster ? '60px' : 'auto'};
            justify-content: center;
          ">
            ${
              isCluster
                ? `<span style="font-size: ${flagSize}px;">üåç</span>`
                : `<span style="font-size: ${flagSize}px;">${d.flag}</span>`
            }
            <span>${displayText}</span>
          </div>
        `;

        el.style.pointerEvents = 'auto';
        el.style.cursor = 'pointer';
        el.style.position = 'relative';
        el.style.zIndex = '1000';

        // Ìò∏Î≤Ñ Ìö®Í≥º
        const labelDiv = el.querySelector('div') as HTMLElement;
        el.addEventListener('mouseenter', () => {
          if (labelDiv) {
            labelDiv.style.transform = 'scale(1.05)';
            labelDiv.style.background = isCluster
              ? 'rgba(74, 144, 226, 1)'
              : 'rgba(255, 255, 255, 1)';
            labelDiv.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.3)';
            labelDiv.style.zIndex = '1001';
          }
        });

        el.addEventListener('mouseleave', () => {
          if (labelDiv) {
            labelDiv.style.transform = 'scale(1)';
            labelDiv.style.background = isCluster
              ? 'rgba(74, 144, 226, 0.95)'
              : 'rgba(255, 255, 255, 0.95)';
            labelDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            labelDiv.style.zIndex = '1000';
          }
        });

        el.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();

          if (isCluster) {
            // ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌÅ¥Î¶≠ Ïãú Ï†ÅÏ†àÌïú Î†àÎ≤®Î°ú Ï§åÏù∏
            const targetAltitude = Math.max(0.8, zoomLevel * 0.4);
            if (globeRef.current) {
              globeRef.current.pointOfView(
                {
                  lat: d.lat,
                  lng: d.lng,
                  altitude: targetAltitude,
                },
                1000
              );
            }
          } else {
            // Îã®Ïùº ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ïãú ÏÑ†ÌÉù
            setSelectedCountry(d.id);
            if (globeRef.current) {
              globeRef.current.pointOfView(
                {
                  lat: d.lat,
                  lng: d.lng,
                  altitude: 1.2,
                },
                1000
              );
            }
          }
        });

        return el;
      });
  }, [clusteredData, selectedCountry]); // clusteredDataÏôÄ selectedCountryÎßå ÏùòÏ°¥ÏÑ±ÏúºÎ°ú ÏÇ¨Ïö©

  return (
    <div
      style={{
        minHeight: '100vh',
        background: 'linear-gradient(135deg, #0c0c1e 0%, #1a1a2e 100%)',
        color: 'white',
        fontFamily:
          '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px',
      }}
    >
      {/* Ìó§Îçî */}
      <div style={{ textAlign: 'center', marginBottom: '40px' }}>
        <h1
          style={{
            fontSize: '28px',
            fontWeight: 'bold',
            marginBottom: '8px',
            color: 'white',
          }}
        >
          {currentPattern.title}
        </h1>
        <p
          style={{
            fontSize: '18px',
            color: '#4a90e2',
            margin: 0,
            marginBottom: '20px',
          }}
        >
          {currentPattern.subtitle}
        </p>

        {/* Í∏ÄÎ°úÎ∏å ÏÑ†ÌÉù Î≤ÑÌäºÎì§ */}
        <div
          style={{
            display: 'flex',
            gap: '10px',
            justifyContent: 'center',
            flexWrap: 'wrap',
          }}
        >
          {travelPatterns.map((pattern, index) => (
            <button
              key={index}
              onClick={() => {
                setCurrentGlobeIndex(index);
                setSelectedCountry(null);
              }}
              style={{
                backgroundColor:
                  currentGlobeIndex === index
                    ? '#4a90e2'
                    : 'rgba(255,255,255,0.1)',
                color: 'white',
                border: '1px solid rgba(255,255,255,0.2)',
                borderRadius: '20px',
                padding: '8px 16px',
                cursor: 'pointer',
                fontSize: '12px',
                fontWeight: '500',
                transition: 'all 0.2s ease',
                backdropFilter: 'blur(10px)',
              }}
            >
              Ìå®ÌÑ¥ {index + 1}
            </button>
          ))}
        </div>
      </div>

      {/* Globe.gl Ïª®ÌÖåÏù¥ÎÑà */}
      <div
        ref={globeEl}
        style={{
          marginBottom: '40px',
          borderRadius: '50%',
          overflow: 'hidden',
          boxShadow: '0 20px 60px rgba(0,0,0,0.5)',
        }}
      />

      {/* Î°úÎî© Î∞è ÏóêÎü¨ ÏÉÅÌÉú ÌëúÏãú */}
      {globeLoading && (
        <div style={{ color: '#4a90e2', marginBottom: '20px' }}>
          üåç Globe.gl Î°úÎî© Ï§ë...
        </div>
      )}

      {globeError && (
        <div
          style={{
            color: '#ff5722',
            marginBottom: '20px',
            textAlign: 'center',
          }}
        >
          ‚ö†Ô∏è {globeError}
        </div>
      )}

      {/* ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Ï†ïÎ≥¥ */}
      {clusteredData.length > 0 && zoomLevel <= 6 && (
        <div
          style={{
            color: '#8892b0',
            fontSize: '12px',
            marginBottom: '20px',
            textAlign: 'center',
          }}
        >
          ÌòÑÏû¨ Ï§å Î†àÎ≤®: {zoomLevel.toFixed(1)} | ÌÅ¥Îü¨Ïä§ÌÑ∞:{' '}
          {clusteredData.length}Í∞ú
        </div>
      )}

      {/* ÏÑ†ÌÉùÎêú Íµ≠Í∞Ä Ï†ïÎ≥¥ */}
      {selectedCountry && (
        <div
          style={{
            backgroundColor: 'rgba(255,255,255,0.1)',
            backdropFilter: 'blur(10px)',
            borderRadius: '15px',
            padding: '20px',
            textAlign: 'center',
            border: '1px solid rgba(255,255,255,0.2)',
          }}
        >
          {(() => {
            const country = currentPattern.countries.find(
              (c: any) => c.id === selectedCountry
            );
            return country ? (
              <>
                <div style={{ fontSize: '30px', marginBottom: '10px' }}>
                  {country.flag}
                </div>
                <h3 style={{ margin: '0 0 5px 0', color: 'white' }}>
                  {country.name}
                </h3>
                <button
                  onClick={() => setSelectedCountry(null)}
                  style={{
                    backgroundColor: country.color,
                    color: 'white',
                    border: 'none',
                    borderRadius: '20px',
                    padding: '8px 20px',
                    cursor: 'pointer',
                    marginTop: '10px',
                  }}
                >
                  Îã´Í∏∞
                </button>
              </>
            ) : null;
          })()}
        </div>
      )}

      {/* ÏïàÎÇ¥ Î©îÏãúÏßÄ */}
      <p
        style={{
          color: '#8892b0',
          fontSize: '12px',
          textAlign: 'center',
          marginTop: '20px',
        }}
      >
        ÏúÑ Î≤ÑÌäºÏúºÎ°ú Îã§Î•∏ Ïó¨Ìñâ Ìå®ÌÑ¥ÏùÑ ÌôïÏù∏ÌïòÍ≥†, ÏßÄÍµ¨Î≥∏ÏùÑ ÌôïÎåÄ/Ï∂ïÏÜåÌïòÎ©∞ ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º
        ÌÅ¥Î¶≠Ìï¥Î≥¥ÏÑ∏Ïöî
      </p>
    </div>
  );
};

export default GlobePrototype;
